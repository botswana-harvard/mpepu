

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tracker &mdash; lab_tracker 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="lab_tracker 1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">lab_tracker 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tracker</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">OneToOneField</span><span class="p">,</span> <span class="n">get_model</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">bhp_base_model.models</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">bhp_lab_tracker.models</span> <span class="kn">import</span> <span class="n">HistoryModel</span><span class="p">,</span> <span class="n">DefaultValueLog</span>
<span class="kn">from</span> <span class="nn">helpers</span> <span class="kn">import</span> <span class="n">TrackerNamedTpl</span>
<span class="kn">from</span> <span class="nn">history_updater</span> <span class="kn">import</span> <span class="n">HistoryUpdater</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NullHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">pass</span>
<span class="n">nullhandler</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">NullHandler</span><span class="p">())</span>


<div class="viewcode-block" id="LabTracker"><a class="viewcode-back" href="../classes.html#tracker.LabTracker">[docs]</a><span class="k">class</span> <span class="nc">LabTracker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An abstract class to track or maintain a history of subject&#39;s lab result value from both the lab_clinic_api models ands protocol scheduled model(s).</span>

<span class="sd">    Required class attributes to be defined on the subclass:</span>
<span class="sd">        * resultitem_test_code: a tuple of test codes for reference to the :mod:`lab_clinic_api.result_item`.</span>
<span class="sd">          For example: (&#39;ELISA&#39;, &#39;RELISA&#39;, &#39;DNAPCR&#39;)</span>
<span class="sd">        * tracker_test_code = a test code to use for results coming from a registered model.</span>
<span class="sd">          For example: &#39;HIV&#39;</span>
<span class="sd">        * group_name = a label to group all records in the history model related to this class instance.</span>
<span class="sd">          Must be unique for each type of value being tracked. For example: &#39;HIV&#39;.</span>

<span class="sd">    Optional class attributes to be defined on the subclass:</span>
<span class="sd">        * models: a tuple of tuples where the containing tuple defines (model_cls, value_attr, date_attr).</span>
<span class="sd">          Use this attribute to include models from your app that capture values not captured in</span>
<span class="sd">          model :class:`lab_clinic_api.models.ResultItem`.</span>

<span class="sd">        .. note:: If models is not defined, the class will just track values in :mod:`lab_clinic_api.result_item`.</span>

<span class="sd">    For example::</span>

<span class="sd">        class InfantHivLabTracker(HivLabTracker):</span>
<span class="sd">            models = [</span>
<span class="sd">                (HivTesting, &#39;pcr_result&#39;, &#39;pcr_date&#39;, None, True),</span>
<span class="sd">                (HivTesting, &#39;elisa_result&#39;, &#39;elisa_date&#39;, None, True)]</span>
<span class="sd">        lab_tracker.register(InfantHivLabTracker)</span>

<span class="sd">    You may also need to add a method on the model to return a known value. For example, for HIV::</span>

<span class="sd">        def get_result_value(self, attr=None):</span>
<span class="sd">            retval = None</span>
<span class="sd">            if not attr in dir(self):</span>
<span class="sd">                raise TypeError(&#39;Attribute {0} does not exist in model {1}&#39;.format(attr, self._meta.object_name))</span>
<span class="sd">            if attr == &#39;is_hiv_pos&#39;:</span>
<span class="sd">                if self.is_hiv_pos.lower() == &#39;yes&#39;:</span>
<span class="sd">                    retval = &#39;POS&#39;</span>
<span class="sd">                else:</span>
<span class="sd">                    retval = &#39;NEG&#39;</span>
<span class="sd">            return retval</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">MODEL_CLS</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">VALUE_ATTR</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">DATE_ATTR</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">IDENTIFIER_ATTR</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">ALLOW_NULL</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">models</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">trackers</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">group_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">tracked_test_codes</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_identifier</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the user does not declare self.models, the tracker will add result_item so that the</span>
<span class="sd">        tracker at least gets what&#39;s in lab_clinic_api tables.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_item_tracker</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trackers</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_models</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subject_identifier</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value_datetime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_default_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracked_test_codes</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_code</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history_inst</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subject_type</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history_query_options</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_dirty</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_subject_identifier</span> <span class="o">=</span> <span class="n">subject_identifier</span>

<div class="viewcode-block" id="LabTracker.set_result_item_tracker"><a class="viewcode-back" href="../classes.html#tracker.LabTracker.set_result_item_tracker">[docs]</a>    <span class="k">def</span> <span class="nf">set_result_item_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the tracker for lab_clinic_api.result_item which is added by default to the list of trackers.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_item_tracker</span> <span class="o">=</span> <span class="n">TrackerNamedTpl</span><span class="p">(</span>
            <span class="n">model_cls</span><span class="o">=</span><span class="n">get_model</span><span class="p">(</span><span class="s">&#39;lab_clinic_api&#39;</span><span class="p">,</span> <span class="s">&#39;resultitem&#39;</span><span class="p">),</span>
            <span class="n">value_attr</span><span class="o">=</span><span class="s">&#39;result_item_value&#39;</span><span class="p">,</span>
            <span class="n">datetime_attr</span><span class="o">=</span><span class="s">&#39;result_item_datetime&#39;</span><span class="p">,</span>
            <span class="n">identifier_attr</span><span class="o">=</span><span class="s">&#39;result__order__order_identifier&#39;</span><span class="p">,</span>
            <span class="n">allow_null</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">get_result_item_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_item_tracker</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_result_item_tracker</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_item_tracker</span>

    <span class="k">def</span> <span class="nf">_set_is_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_dirty</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">is_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dirty</span>

<div class="viewcode-block" id="LabTracker.set_value"><a class="viewcode-back" href="../classes.html#tracker.LabTracker.set_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the result value relative to value_datetime OR the default value if there is no</span>
<span class="sd">        information for this subject in the History model.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_history_inst</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_value</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_default_value_used</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Unable to determine the current value. May not be None.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_is_dirty</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value_datetime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value_datetime</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value_datetime</span><span class="p">(</span><span class="n">value_datetime</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dirty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

<div class="viewcode-block" id="LabTracker.set_history"><a class="viewcode-back" href="../classes.html#tracker.LabTracker.set_history">[docs]</a>    <span class="k">def</span> <span class="nf">set_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_desc</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets to an ordered HistoryModel queryset for this subject filtered for records on or before value_datetime.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">order_by</span> <span class="o">=</span> <span class="s">&#39;value_datetime&#39;</span>
        <span class="k">if</span> <span class="n">order_desc</span><span class="p">:</span>
            <span class="n">order_by</span> <span class="o">=</span> <span class="s">&#39;-{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">order_by</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_history</span><span class="p">()</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;subject_identifier&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subject_identifier</span><span class="p">(),</span>
                   <span class="s">&#39;group_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">()}</span>
        <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;value_datetime__lte&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_datetime</span><span class="p">()})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="n">HistoryModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">order_by</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LabTracker.get_history"><a class="viewcode-back" href="../classes.html#tracker.LabTracker.get_history">[docs]</a>    <span class="k">def</span> <span class="nf">get_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value_datetime</span><span class="p">,</span> <span class="n">order_desc</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an ordered HistoryModel queryset for this subject filtered for records on or before value_datetime.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">order_desc</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">order_desc</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value_datetime</span><span class="p">(</span><span class="n">value_datetime</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dirty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_history</span><span class="p">(</span><span class="n">order_desc</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history</span>
</div>
<div class="viewcode-block" id="LabTracker.get_history_as_list"><a class="viewcode-back" href="../classes.html#tracker.LabTracker.get_history_as_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_history_as_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference_datetime</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns all values on or before :attr:`reference_datetime` for a subject as a list in ascending chronological order.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reference_datetime</span><span class="p">:</span>
            <span class="n">reference_datetime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_datetime</span><span class="p">()</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_history</span><span class="p">(</span><span class="n">reference_datetime</span><span class="p">,</span> <span class="n">order_desc</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">qs</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">qs</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="LabTracker.get_history_as_string"><a class="viewcode-back" href="../classes.html#tracker.LabTracker.get_history_as_string">[docs]</a>    <span class="k">def</span> <span class="nf">get_history_as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference_datetime</span><span class="p">,</span> <span class="n">mapped</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a subject&#39;s qualitative values joined as a string in ascending chronological order.</span>

<span class="sd">        Args:</span>
<span class="sd">            * mapped: if False do not attempt to use a display map (default=True).</span>

<span class="sd">        If :attr:`mapped` is True and a display map is defined in :func:`get_display_map_prep`, the display map is</span>
<span class="sd">        inverted and a string of values is generated from the map.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_display_map</span><span class="p">():</span>
            <span class="n">mapped</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">retlst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">inv_display_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">mapped</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_display_map</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">inv_display_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv_display_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">inv_display_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_history_as_list</span><span class="p">(</span><span class="n">reference_datetime</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mapped</span><span class="p">:</span>
                <span class="n">retlst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inv_display_map</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">retlst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">retlst</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">set_is_default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_default_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_default_value</span> <span class="o">=</span> <span class="n">is_default_value</span> <span class="ow">or</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_is_default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_default_value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_is_default_value</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_default_value</span>

    <span class="k">def</span> <span class="nf">set_trackers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trackers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># add the default &quot;result item&quot; tuple, need this one at least</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_result_item_tracker</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_result_item_tracker</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">tracker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackers</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tracker</span><span class="p">,</span> <span class="n">TrackerNamedTpl</span><span class="p">):</span>
                <span class="c"># trackers are declared as tuples but must be named tuples, so convert</span>
                <span class="n">tracker</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tracker</span><span class="p">)</span>
                <span class="n">tracker</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tracker</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">TrackerNamedTpl</span><span class="o">.</span><span class="n">_fields</span><span class="p">))])</span>
                <span class="n">tracker</span> <span class="o">=</span> <span class="n">TrackerNamedTpl</span><span class="p">(</span><span class="o">*</span><span class="n">tracker</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">model_cls</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&#39;tracker tuple element </span><span class="se">\&#39;</span><span class="s">model_cls</span><span class="se">\&#39;</span><span class="s"> must be a Model class. Got {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">model_cls</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">value_attr</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&#39;tracker tuple element </span><span class="se">\&#39;</span><span class="s">value_attr</span><span class="se">\&#39;</span><span class="s"> must be a string. Got {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">value_attr</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">datetime_attr</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&#39;tracker tuple element </span><span class="se">\&#39;</span><span class="s">datetime_attr</span><span class="se">\&#39;</span><span class="s"> must be a string. Got {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">datetime_attr</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">identifier_attr</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">identifier_attr</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&#39;tracker tuple element </span><span class="se">\&#39;</span><span class="s">identifier_attr</span><span class="se">\&#39;</span><span class="s"> must be a string. Got {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">identifier_attr</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trackers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tracker</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_trackers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trackers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_trackers</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trackers</span>

    <span class="k">def</span> <span class="nf">set_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tracker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trackers</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">model_cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_models</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_models</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span>

    <span class="k">def</span> <span class="nf">set_group_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&#39;Attribute </span><span class="se">\&#39;</span><span class="s">_group_name</span><span class="se">\&#39;</span><span class="s"> cannot be None. Set </span><span class="se">\&#39;</span><span class="s">group_name</span><span class="se">\&#39;</span><span class="s"> as a class attribute in the class declaration&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_group_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_group_name</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_name</span>

<div class="viewcode-block" id="LabTracker.get_default_value"><a class="viewcode-back" href="../classes.html#tracker.LabTracker.get_default_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the a value if None is available.</span>

<span class="sd">        Users may override, carefully&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;UNK&#39;</span>
</div>
<div class="viewcode-block" id="LabTracker._get_default_value"><a class="viewcode-back" href="../classes.html#tracker.LabTracker._get_default_value">[docs]</a>    <span class="k">def</span> <span class="nf">_get_default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the default value when none is available from the HistoryModel.&quot;&quot;&quot;</span>
        <span class="n">default_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_is_default_value</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default_value</span>
</div>
    <span class="k">def</span> <span class="nf">_get_default_value_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>

<div class="viewcode-block" id="LabTracker.get_value_map_prep"><a class="viewcode-back" href="../classes.html#tracker.LabTracker.get_value_map_prep">[docs]</a>    <span class="k">def</span> <span class="nf">get_value_map_prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Users should override to use a custom map for a given tracker model.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="LabTracker._get_value_map"><a class="viewcode-back" href="../classes.html#tracker.LabTracker._get_value_map">[docs]</a>    <span class="k">def</span> <span class="nf">_get_value_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maps an instance result value according to a configured map, if such a map exists.&quot;&quot;&quot;</span>
        <span class="c"># check model exists</span>
        <span class="k">for</span> <span class="n">tracker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trackers</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">model_cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_map_prep</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="k">def</span> <span class="nf">_set_history_query_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">bhp_visit_tracking.models</span> <span class="kn">import</span> <span class="n">BaseVisitTracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history_query_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tracker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trackers</span><span class="p">():</span>
            <span class="n">query_string</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">options</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">model_cls</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_result_item_tracker</span><span class="p">()</span><span class="o">.</span><span class="n">model_cls</span><span class="p">:</span>
                <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;result__subject_identifier&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subject_identifier</span><span class="p">(),</span>
                           <span class="s">&#39;test_code__code__in&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tracked_test_codes</span><span class="p">()}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tracker</span><span class="o">.</span><span class="n">model_cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;subject_identifier&#39;</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">:</span>
                    <span class="n">query_string</span> <span class="o">=</span> <span class="s">&#39;subject_identifier&#39;</span>
                <span class="k">elif</span> <span class="s">&#39;registered_subject&#39;</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">:</span>
                    <span class="n">query_string</span> <span class="o">=</span> <span class="s">&#39;registered_subject__subject_identifier&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">tracker</span><span class="o">.</span><span class="n">model_cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">(</span><span class="n">ForeignKey</span><span class="p">,</span> <span class="n">OneToOneField</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="n">BaseVisitTracking</span><span class="p">):</span>
                                <span class="n">query_string</span> <span class="o">=</span> <span class="s">&#39;{visit_field}__appointment__registered_subject__subject_identifier&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">visit_field</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">query_string</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">((</span><span class="s">&#39;Missing subject_identifier attribute or a relation to one. The model class {0} is&#39;</span>
                                    <span class="s">&#39; not a subclass of BaseVisitTracking and nor does it have a relation to RegisteredSubject.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">model_cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">))</span>
                <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="n">query_string</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subject_identifier</span><span class="p">()}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Unable to determine the query options for tracker </span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tracker</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_history_query_options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">tracker</span><span class="p">:</span> <span class="n">options</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_get_history_query_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracker</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history_query_options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_history_query_options</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history_query_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tracker</span><span class="p">)</span>

<div class="viewcode-block" id="LabTracker.update_history"><a class="viewcode-back" href="../classes.html#tracker.LabTracker.update_history">[docs]</a>    <span class="k">def</span> <span class="nf">update_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Updates the HistoryModel with the subject&#39;s values found in any registered models and ResultItem.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tracker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trackers</span><span class="p">():</span>
            <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_history_query_options</span><span class="p">(</span><span class="n">tracker</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">model_inst</span> <span class="ow">in</span> <span class="n">tracker</span><span class="o">.</span><span class="n">model_cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">):</span>
                <span class="n">HistoryUpdater</span><span class="p">(</span><span class="n">model_inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(),</span> <span class="n">tracker</span><span class="o">=</span><span class="n">tracker</span><span class="p">,</span> <span class="n">tracked_test_codes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_tracked_test_codes</span><span class="p">())</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="LabTracker.set_value_datetime"><a class="viewcode-back" href="../classes.html#tracker.LabTracker.set_value_datetime">[docs]</a>    <span class="k">def</span> <span class="nf">set_value_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets value_datetime, None is allowed.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_is_dirty</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value_datetime</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_datetime</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Attribute _value_datetime may not be None.&#39;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">get_value_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_datetime</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value_datetime</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_datetime</span>

<div class="viewcode-block" id="LabTracker.set_subject_identifier"><a class="viewcode-back" href="../classes.html#tracker.LabTracker.set_subject_identifier">[docs]</a>    <span class="k">def</span> <span class="nf">set_subject_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the subject_identifier which may not be None.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subject_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_subject_identifier</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subject_identifier</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Attribute _subject_identifier may not be None.&#39;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">get_subject_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subject_identifier</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_subject_identifier</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subject_identifier</span>

<div class="viewcode-block" id="LabTracker._set_history_inst"><a class="viewcode-back" href="../classes.html#tracker.LabTracker._set_history_inst">[docs]</a>    <span class="k">def</span> <span class="nf">_set_history_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets to the most recent history model instance relative to the value_datetime or to a default HistoryModel instance.&quot;&quot;&quot;</span>
        <span class="c"># create a default instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history_inst</span> <span class="o">=</span> <span class="n">HistoryModel</span><span class="p">(</span>
            <span class="n">subject_identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_subject_identifier</span><span class="p">(),</span>
            <span class="n">value_datetime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_default_value_datetime</span><span class="p">(),</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_default_value</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">HistoryModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">subject_identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_subject_identifier</span><span class="p">(),</span>
                                       <span class="n">group_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(),</span>
                                       <span class="n">value_datetime__lte</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value_datetime</span><span class="p">())</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c"># set to most recent relative to value_datetime</span>
            <span class="c"># TODO: this may cause problems for value_datetime when queried by date (with no time)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_history_inst</span> <span class="o">=</span> <span class="n">HistoryModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">subject_identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_subject_identifier</span><span class="p">(),</span>
                <span class="n">group_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(),</span>
                <span class="n">value_datetime__lte</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value_datetime</span><span class="p">()</span>
                <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-value_datetime&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_is_dirty</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_get_history_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history_inst</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dirty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_history_inst</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history_inst</span>

<div class="viewcode-block" id="LabTracker._log_default_value_used"><a class="viewcode-back" href="../classes.html#tracker.LabTracker._log_default_value_used">[docs]</a>    <span class="k">def</span> <span class="nf">_log_default_value_used</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Logs that a default value was used. &quot;&quot;&quot;</span>
        <span class="n">default_value_log</span> <span class="o">=</span> <span class="n">DefaultValueLog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">subject_identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_subject_identifier</span><span class="p">(),</span>
            <span class="n">group_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(),</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_default_value</span><span class="p">(),</span>
            <span class="n">value_datetime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_default_value_datetime</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">default_value_log</span>
</div>
    <span class="k">def</span> <span class="nf">_get_display_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracker</span><span class="p">):</span>
        <span class="n">display_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">display_value</span><span class="p">:</span>
            <span class="n">display_map</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">_get_display_map</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">display_map</span><span class="p">:</span>
                <span class="n">display_value</span> <span class="o">=</span> <span class="n">display_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">display_value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tracker</span><span class="o">.</span><span class="n">allow_null</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Result value </span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> did not match any value in the display map </span><span class="se">\&#39;</span><span class="s">{1}</span><span class="se">\&#39;</span><span class="s">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(),</span> <span class="n">display_map</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">display_value</span>

    <span class="k">def</span> <span class="nf">_get_display_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_display_map_prep</span><span class="p">()</span>

<div class="viewcode-block" id="LabTracker.get_display_map_prep"><a class="viewcode-back" href="../classes.html#tracker.LabTracker.get_display_map_prep">[docs]</a>    <span class="k">def</span> <span class="nf">get_display_map_prep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary that may be used to map values for storage in the :class:`HistoryModel` to value formats used in :class:`ResultItem` model.</span>

<span class="sd">            Format {given this value: store this value}.</span>

<span class="sd">            This is useful if update_prep adds results that are not described in the same format as the :class:`ResultItem` model.</span>

<span class="sd">            For example:</span>
<span class="sd">                {&#39;A&#39;: &#39;POS&#39;, &#39;B&#39;: NEG} will store POS and NEG given A, B. POS, NEG is how it is stored in the :class:`ResultItem` model.</span>

<span class="sd">            Also, the map is inverted to generate a string of values using this map returning &#39;AB&#39; instead of &#39;POSNEG&#39;.</span>

<span class="sd">            Users may override.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="k">def</span> <span class="nf">_set_tracked_test_codes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracked_test_codes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_test_codes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracked_test_codes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&#39;Class attribute </span><span class="se">\&#39;</span><span class="s">tracked_test_codes</span><span class="se">\&#39;</span><span class="s"> may not be None. Should be a test code or tuple of test codes. Set </span><span class="se">\&#39;</span><span class="s">tracked_test_codes</span><span class="se">\&#39;</span><span class="s"> in the class declaration for {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tracked_test_codes</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tracked_test_codes</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tracked_test_codes</span><span class="p">,</span> <span class="p">)</span>

<div class="viewcode-block" id="LabTracker._get_tracked_test_codes"><a class="viewcode-back" href="../classes.html#tracker.LabTracker._get_tracked_test_codes">[docs]</a>    <span class="k">def</span> <span class="nf">_get_tracked_test_codes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a tuple of test codes to track.</span>

<span class="sd">        If not listed here, the history model will not be updated with the instance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracked_test_codes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_tracked_test_codes</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracked_test_codes</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">lab_tracker 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, erik van widenfelt.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>